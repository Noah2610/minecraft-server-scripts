#!/bin/bash
# Creates a backup of the world/ ($WORLD_DIR) directory.

source "$( dirname "$0" )/lib.sh"

# Check that 'zip' is available.
check zip

print_date

# Exit if the server is not running.
is_server_running || err "Server isn't running."

print_chat "$BACKUP_CHAT_MSG_START"
msg "BACKUP STARTED"

# Save world
print_chat "Saving world..."
server_cmd "save-all"
# Sleep a couple seconds, to make sure minecraft finished saving the world.
sleep "$BACKUP_SLEEP_AFTER_SAVE"

# Backup world
print_chat "Backing-up $WORLD_DIR directory... (hopefully game has finished saving)"
mkdir -p "$BACKUP_DIR"
msg "Zipping $WORLD_DIR directory"
try_run \
    zip \
        -r "${BACKUP_DIR}/${WORLD_DIR}.zip" \
        "${SERVER_DIR}/${WORLD_DIR}"

print_chat "$BACKUP_CHAT_MSG_END"
msg "BACKUP COMPLETE"
