#!/bin/bash
# Creates a backup of the world/ ($WORLD_DIR) directory.

source "$( dirname "$0" )/lib.sh"

BACKUP_CHAT_MSG_START="Creating backup of world..."
BACKUP_CHAT_MSG_END="Backup complete."
BACKUP_CHAT_MSG_BACKING_UP="Backing-up $WORLD_DIR directory... (hopefully game has finished saving)"

# Check that 'zip' is available.
check zip

print_date

is_server_running
server_running=$?

[ $server_running -eq 0 ] \
    && print_chat "$BACKUP_CHAT_MSG_START"

msg "Starting backup..."

# Save world
[ $server_running -eq 0 ] \
    && print_chat "Saving world..." \
    && server_cmd "save-all" \
    && sleep "$BACKUP_SLEEP_AFTER_SAVE"
    # Sleep a couple seconds, to make sure minecraft finished saving the world.

# Backup world
[ $server_running -eq 0 ] \
    && print_chat "Backing-up $WORLD_DIR directory..."
mkdir -p "$BACKUP_DIR"
msg "Zipping $WORLD_DIR directory"
try_run_hidden \
    zip \
        -r "${BACKUP_DIR}/${WORLD_DIR}.zip" \
        "${SERVER_DIR}/${WORLD_DIR}"

[ $server_running -eq 0 ] \
    && print_chat "$BACKUP_CHAT_MSG_END"
msg "Backup compelete!\n${BACKUP_DIR}/${WORLD_DIR}.zip"
